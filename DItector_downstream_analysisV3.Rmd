---
## title: "cbDVG downstream analysis"
author: "Dr Biruhalem"
date: "2023-12-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#loading R packages libraries 

```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(reticulate)
library(ggsignif)
library(gridExtra)
```

#-------------
## Loading data
#-------------

```{r}

dvg <- read.csv("D:/SSPE_raw.fatsq_files/DI-tector/merged_output_V2_all.csv")  # merged_output.txt was saved as merged_output_V2_all.csv and loaded 

head(dvg)

```

#---------------------------
## Sumerizing the DVG counts
#---------------------------

#Sumerizing the counts of forward and reverse strand to total_count. For a given DVG in each sample, if the DVG has a swich in BP_pos and RI_pos in the same sample, then add the Count values of both to total_count. Else keep the Count value as total_count


```{r}
# Create the 'strand' column
dvg <- dvg %>%
  mutate(strand = ifelse(BP_Pos - RI_Pos < 0, "minus", "plus"))

dvg <- dvg %>%
  mutate(
    reverse = sapply(1:nrow(dvg), function(i) {
      row <- dvg[i, ]
      any(dvg$Samples == row$Samples & dvg$BP_Pos == row$RI_Pos & dvg$RI_Pos == row$BP_Pos)
    })
  )

# Create the 'total_count' column within each sample
dvg$total_count <- sapply(1:nrow(dvg), function(i) {
  row <- dvg[i, ]
  sum_counts <- sum(dvg$Counts[dvg$Samples == row$Samples & dvg$BP_Pos == row$RI_Pos & dvg$RI_Pos == row$BP_Pos])
  return(row$Counts + sum_counts)
})

# Sort the data frame by 'total_count' in descending order
dvg <- dvg[order(-dvg$total_count), ]

head(dvg, 100)

table(dvg$strand, dvg$reverse)

```

```{r}
head(dvg, 100)
```

##Filtering unique DVG. For DVG with bith plus and minus strand, select the minus strand. DVGs with only plus or minus strand will be aslo kept as unique DVG.

#selecting data with minus strand if exist

```{r}
dvg1 <- dvg %>%
  filter(ifelse(reverse, strand == "minus", TRUE))
head(dvg1)

table(dvg1$strand, dvg1$reverse)

#save the file

write.csv(dvg1, "C:/Users/user/Desktop/SSPE_DItector/DItector/dvg1.csv")

```

#---------------------------------------------------------------
## Extracting 5'cbDVGs with rule of six and more than 100 copies 
#---------------------------------------------------------------

```{r}
dvg_filtered <- subset(dvg1, Rule_of_six == "YES" & total_count > 100)
dim(dvg_filtered)

dvg_filtered_cb <- subset(dvg_filtered, DVG.stype == "5'cb/sbDVG")

dim(dvg_filtered_cb)

write.csv(dvg_filtered_cb, "C:/Users/user/Desktop/SSPE_DItector/DItector/dvg_filtered_cb.csv")

```

#extracting the 276 cbDVGs for heatmap


```{r}
pivot_df <- dvg_filtered_cb %>%
  pivot_wider(
    id_cols = BP_Pos_RI_Pos,
    names_from = Samples,
    values_from = total_count,
    values_fill = 0  # Replace missing values with 0
  )

# Print the result
head(pivot_df)
```


```{r}
# 
pivot_df <- dvg_filtered_cb %>%
  pivot_wider(
    id_cols = BP_Pos_RI_Pos,
    names_from = Samples,
    values_from = total_count,
    values_fill = 0  # Replace missing values with 0
  ) %>%
  mutate(Length = dvg_filtered_cb$Length[match(BP_Pos_RI_Pos, dvg_filtered_cb$BP_Pos_RI_Pos)])

# Print the result
head(pivot_df)

write.csv(pivot_df, "C:/Users/user/Desktop/SSPE_DItector/DItector/pivot_df.csv")

```

#----------------------------
# Scater plots for Figure 4B-H
#--------------------------------






